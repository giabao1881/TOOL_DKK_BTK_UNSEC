<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ tạo đơn khởi kiện hàng loạt - Nhiều khách hàng</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        body {
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        
        h2 {
            color: #34495e;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        h3 {
            color: #2c3e50;
            margin: 15px 0 10px 0;
        }
        
        h4 {
            color: #2c3e50;
            margin: 10px 0 5px 0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .loan-contract {
            background: #e8f4fc;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        
        .debt-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        .debt-table td {
            padding: 8px;
            border: 1px solid #ddd;
        }
        
        .debt-table tr:last-child {
            font-weight: bold;
            background: #f0f0f0;
        }
        
        .btn {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #27ae60;
        }
        
        .btn-success:hover {
            background: #219653;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .btn-warning:hover {
            background: #d35400;
        }
        
        .action-buttons {
            text-align: center;
            margin: 20px 0;
        }
        
        .contract-count, .customer-count {
            text-align: center;
            margin: 15px 0;
            font-weight: bold;
            color: #2c3e50;
            padding: 10px;
            background: #ecf0f1;
            border-radius: 5px;
        }
        
        .hidden {
            display: none;
        }
        
        #previewSection {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fff;
        }
        
        #documentPreview {
            white-space: pre-wrap;
            font-family: 'Times New Roman', serif;
            line-height: 1.5;
            max-height: 600px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #eee;
            background: #fefefe;
        }
        
        .download-btn {
            background: #27ae60;
            margin-top: 10px;
        }
        
        .download-btn:hover {
            background: #219653;
        }
        
        .customer-item {
            background: #fff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 2px solid #bdc3c7;
            position: relative;
        }
        
        .customer-header {
            background: #34495e;
            color: white;
            padding: 10px;
            margin: -15px -15px 15px -15px;
            border-radius: 3px 3px 0 0;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .remove-customer {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .remove-customer:hover {
            background: #c0392b;
        }
        
        .tab-container {
            margin: 20px 0;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #3498db;
        }
        
        .tab {
            padding: 10px 20px;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            cursor: pointer;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #bdc3c7;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .batch-actions {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .template-section {
            background: #d5edf7;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: #27ae60;
            width: 0%;
            transition: width 0.3s;
        }
        
        .customer-list {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CÔNG CỤ TẠO ĐƠN KHỞI KIỆN HÀNG LOẠT - NHIỀU KHÁCH HÀNG</h1>
        
        <!-- Tab container -->
        <div class="tab-container">
            <div class="tabs">
                <div class="tab active" onclick="switchTab(1)">THIẾT LẬP MẪU ĐƠN</div>
                <div class="tab" onclick="switchTab(2)">NHẬP DANH SÁCH KHÁCH HÀNG</div>
                <div class="tab" onclick="switchTab(3)">XEM TRƯỚC & TẢI VỀ</div>
            </div>
            
            <!-- Tab 1: Thiết lập mẫu đơn -->
            <div id="tab1" class="tab-content active">
                <div class="template-section">
                    <h3>THIẾT LẬP MẪU ĐƠN CHUNG</h3>
                    <p><em>Các thông tin này sẽ được áp dụng cho tất cả khách hàng</em></p>
                </div>
                
                <!-- Form nhập thông tin chung -->
                <div class="form-section">
                    <h2>THÔNG TIN CHUNG</h2>
                    
                    <div class="form-group">
                        <label for="courtName">Tên Tòa án:</label>
                        <input type="text" id="courtName" value="TÒA ÁN NHÂN DÂN KHU VỰC 8, THÀNH PHỐ HỒ CHÍ MINH">
                    </div>
                    
                    <div class="form-group">
                        <label for="currentDate">Ngày lập đơn:</label>
                        <input type="text" id="currentDate" value="Thành phố Hồ Chí Minh, ngày 22 tháng 11 năm 2025">
                    </div>
                </div>
                
                <!-- Form nhập thông tin bên khởi kiện -->
                <div class="form-section">
                    <h2>THÔNG TIN BÊN KHỞI KIỆN</h2>
                    
                    <div class="form-group">
                        <label for="plaintiffName">Tên ngân hàng:</label>
                        <input type="text" id="plaintiffName" value="Ngân hàng TMCP Việt Nam Thịnh Vượng (VPBank)">
                    </div>
                    
                    <div class="form-group">
                        <label for="plaintiffAddress">Địa chỉ trụ sở:</label>
                        <input type="text" id="plaintiffAddress" value="Số 89 Láng Hạ, phường Đống Đa, Tp. Hà Nội">
                    </div>
                    
                    <div class="form-group">
                        <label for="plaintiffContact">Địa chỉ liên lạc:</label>
                        <input type="text" id="plaintiffContact" value="Tầng 1, số 96 Cao Thắng, phường Bàn Cờ, Tp. Hồ Chí Minh">
                    </div>
                    
                    <div class="form-group">
                        <label for="legalRepresentative">Người đại diện theo pháp luật:</label>
                        <input type="text" id="legalRepresentative" value="Ông Ngô Chí Dũng - Chủ tịch Hội đồng quản trị">
                    </div>
                    
                    <div class="form-group">
                        <label for="authorizedRepresentative">Người đại diện theo ủy quyền:</label>
                        <input type="text" id="authorizedRepresentative" value="Ông Đỗ Thành Trung - Chức vụ: Phó Giám đốc Trung tâm THN KHDN & XLN pháp lý">
                    </div>
                    
                    <div class="form-group">
                        <label for="authorizationDoc">Văn bản ủy quyền:</label>
                        <input type="text" id="authorizationDoc" value="Văn bản ủy quyền số 50/2025/UQN-CTQT ngày 07/11/2025 của Chủ tịch Hội đồng quản trị Ngân hàng TMCP Việt Nam Thịnh Vượng - VPBank">
                    </div>
                </div>
                
                <!-- Form nhập thông tin hợp đồng mẫu -->
                <div class="form-section">
                    <h2>MẪU HỢP ĐỒNG VAY (Áp dụng chung)</h2>
                    
                    <div id="contractsContainer">
                        <!-- Hợp đồng 1 -->
                        <div class="loan-contract" id="contract1">
                            <h3>MẪU HỢP ĐỒNG VAY 1</h3>
                            
                            <div class="form-group">
                                <label for="contract1Type">Loại hợp đồng:</label>
                                <input type="text" id="contract1Type" value="Giấy đăng ký kiêm hợp đồng cho vay không TSBĐ, mở & sử dụng tài khoản thanh toán và dịch vụ ngân hàng điện tử">
                            </div>
                            
                            <div class="form-group">
                                <label for="contract1Date">Ngày ký:</label>
                                <input type="text" id="contract1Date" value="08/12/2023">
                            </div>
                            
                            <div class="form-group">
                                <label for="contract1Amount">Số tiền vay:</label>
                                <input type="text" id="contract1Amount" value="30.000.000 đồng">
                            </div>
                            
                            <div class="form-group">
                                <label for="contract1Purpose">Mục đích vay:</label>
                                <input type="text" id="contract1Purpose" value="vay tiêu dùng">
                            </div>
                            
                            <div class="form-group">
                                <label for="contract1Term">Thời hạn vay:</label>
                                <input type="text" id="contract1Term" value="48 tháng">
                            </div>
                            
                            <div class="form-group">
                                <label for="contract1Interest">Lãi suất:</label>
                                <input type="text" id="contract1Interest" value="23%/năm được cố định đến kỳ điều chỉnh lãi suất gần nhất, sau đó định kỳ điều chỉnh 03 tháng/01 lần (+) biên độ 18%/năm">
                            </div>
                            
                            <h4>Dư nợ đến ngày:</h4>
                            <input type="text" id="debtDate1" value="20/11/2025">
                            
                            <table class="debt-table">
                                <tr>
                                    <td>Nợ gốc:</td>
                                    <td><input type="text" id="principal1" value="27.042.271 đồng"></td>
                                </tr>
                                <tr>
                                    <td>Nợ lãi:</td>
                                    <td><input type="text" id="interest1" value="32.070.580 đồng"></td>
                                </tr>
                                <tr>
                                    <td>Tổng cộng:</td>
                                    <td><input type="text" id="total1" value="59.112.851 đồng"></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div class="contract-count" id="contractCount">Số lượng mẫu hợp đồng: 1</div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="addContract()">+ Thêm mẫu hợp đồng</button>
                        <button class="btn btn-danger" onclick="removeContract()">- Xóa mẫu hợp đồng</button>
                    </div>
                </div>
                
                <!-- Form nhập thông tin vi phạm mẫu -->
                <div class="form-section">
                    <h2>MẪU THÔNG TIN VI PHẠM</h2>
                    
                    <div class="form-group">
                        <label for="violationDate">Ngày bắt đầu vi phạm:</label>
                        <input type="text" id="violationDate" value="10/05/2023">
                    </div>
                    
                    <div class="form-group">
                        <label for="violationDescription">Mô tả vi phạm:</label>
                        <textarea id="violationDescription" rows="4" style="width:100%; padding:8px 12px; border:1px solid #ddd; border-radius:4px;">Trong quá trình sử dụng vốn vay của những Hợp đồng cho vay trên, khách hàng đã quá hạn thanh toán nợ gốc và lãi vay cho VPBank. Mặc dù, Ngân hàng đã tạo điều kiện về thời gian cho khách hàng trả nợ nhưng phía khách hàng vẫn không có phương án trả dứt nợ cho ngân hàng.

Xét thấy bên vay không còn khả năng thanh toán nợ, do đó VPBank đã chuyển toàn bộ khoản vay sang nợ quá hạn và thông báo chấm dứt việc thực hiện đối với hợp đồng cho vay trên, đồng thời tiến hành khởi kiện đương sự tại Toà án nhân dân có thẩm quyền để giải quyết.</textarea>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="switchTab(2)">TIẾP THEO: NHẬP DANH SÁCH KHÁCH HÀNG</button>
                </div>
            </div>
            
            <!-- Tab 2: Nhập danh sách khách hàng -->
            <div id="tab2" class="tab-content">
                <div class="batch-actions">
                    <h3>NHẬP DANH SÁCH KHÁCH HÀNG</h3>
                    <p>Thêm thông tin cho từng khách hàng. Các thông tin từ Tab 1 sẽ được áp dụng tự động.</p>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="addCustomer()">+ THÊM KHÁCH HÀNG</button>
                    <button class="btn btn-warning" onclick="importFromExcel()">NHẬP TỪ EXCEL</button>
                    <button class="btn btn-danger" onclick="clearAllCustomers()">XÓA TẤT CẢ</button>
                </div>
                
                <div class="customer-count" id="customerCount">Số lượng khách hàng: 0</div>
                
                <div id="customersContainer" class="customer-list">
                    <!-- Các khách hàng sẽ được thêm vào đây -->
                </div>
                
                <div class="action-buttons">
                    <button class="btn" onclick="switchTab(1)">QUAY LẠI</button>
                    <button class="btn btn-success" onclick="generateAllDocuments()">TIẾP THEO: TẠO ĐƠN HÀNG LOẠT</button>
                </div>
            </div>
            
            <!-- Tab 3: Xem trước và tải về -->
            <div id="tab3" class="tab-content">
                <div class="batch-actions">
                    <h3>KẾT QUẢ TẠO ĐƠN HÀNG LOẠT</h3>
                    <p>Xem trước và tải về tất cả đơn khởi kiện đã tạo</p>
                </div>
                
                <div class="customer-count" id="resultCount">Đã tạo đơn cho: 0 khách hàng</div>
                
                <div class="progress-bar">
                    <div class="progress" id="generationProgress"></div>
                </div>
                
                <div id="resultsContainer">
                    <!-- Kết quả tạo đơn sẽ hiển thị ở đây -->
                </div>
                
                <div class="action-buttons">
                    <button class="btn" onclick="switchTab(2)">QUAY LẠI</button>
                    <button class="btn btn-success" onclick="downloadAllDocuments()">TẢI TẤT CẢ ĐƠN (.ZIP)</button>
                    <button class="btn download-btn" onclick="downloadSummary()">TẢI BÁO CÁO TỔNG HỢP</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Biến toàn cục
        let contractCount = 1;
        let customerCount = 0;
        let customers = [];
        let generatedDocuments = [];
        
        // Chuyển tab
        function switchTab(tabNumber) {
            // Ẩn tất cả tab content
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Ẩn tất cả tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Hiện tab được chọn
            document.getElementById(`tab${tabNumber}`).classList.add('active');
            document.querySelectorAll('.tab')[tabNumber - 1].classList.add('active');
        }
        
        // Thêm/xóa hợp đồng mẫu
        function addContract() {
            contractCount++;
            const newContract = document.createElement('div');
            newContract.className = 'loan-contract';
            newContract.id = `contract${contractCount}`;
            
            newContract.innerHTML = `
                <h3>MẪU HỢP ĐỒNG VAY ${contractCount}</h3>
                
                <div class="form-group">
                    <label for="contract${contractCount}Type">Loại hợp đồng:</label>
                    <input type="text" id="contract${contractCount}Type" placeholder="Loại hợp đồng">
                </div>
                
                <div class="form-group">
                    <label for="contract${contractCount}Date">Ngày ký:</label>
                    <input type="text" id="contract${contractCount}Date" placeholder="Ngày ký">
                </div>
                
                <div class="form-group">
                    <label for="contract${contractCount}Amount">Số tiền vay/Hạn mức:</label>
                    <input type="text" id="contract${contractCount}Amount" placeholder="Số tiền vay">
                </div>
                
                <div class="form-group">
                    <label for="contract${contractCount}Purpose">Mục đích vay:</label>
                    <input type="text" id="contract${contractCount}Purpose" placeholder="Mục đích vay">
                </div>
                
                <div class="form-group">
                    <label for="contract${contractCount}Term">Thời hạn vay (nếu có):</label>
                    <input type="text" id="contract${contractCount}Term" placeholder="Thời hạn vay">
                </div>
                
                <div class="form-group">
                    <label for="contract${contractCount}Interest">Lãi suất:</label>
                    <input type="text" id="contract${contractCount}Interest" placeholder="Lãi suất">
                </div>
                
                <h4>Dư nợ đến ngày:</h4>
                <input type="text" id="debtDate${contractCount}" placeholder="Ngày tính nợ">
                
                <table class="debt-table">
                    <tr>
                        <td>Nợ gốc:</td>
                        <td><input type="text" id="principal${contractCount}" placeholder="Nợ gốc"></td>
                    </tr>
                    <tr>
                        <td>Nợ lãi:</td>
                        <td><input type="text" id="interest${contractCount}" placeholder="Nợ lãi"></td>
                    </tr>
                    <tr>
                        <td>Tổng cộng:</td>
                        <td><input type="text" id="total${contractCount}" placeholder="Tổng cộng"></td>
                    </tr>
                </table>
            `;
            
            document.getElementById('contractsContainer').appendChild(newContract);
            document.getElementById('contractCount').textContent = `Số lượng mẫu hợp đồng: ${contractCount}`;
        }
        
        function removeContract() {
            if (contractCount > 1) {
                const lastContract = document.getElementById(`contract${contractCount}`);
                lastContract.remove();
                contractCount--;
                document.getElementById('contractCount').textContent = `Số lượng mẫu hợp đồng: ${contractCount}`;
            } else {
                alert('Phải có ít nhất 1 mẫu hợp đồng');
            }
        }
        
        // Quản lý khách hàng
        function addCustomer() {
            customerCount++;
            const customerId = `customer_${Date.now()}_${customerCount}`;
            
            const newCustomer = document.createElement('div');
            newCustomer.className = 'customer-item';
            newCustomer.id = customerId;
            
            newCustomer.innerHTML = `
                <div class="customer-header">
                    <span>KHÁCH HÀNG ${customerCount}</span>
                    <button class="remove-customer" onclick="removeCustomer('${customerId}')">Xóa</button>
                </div>
                
                <div class="form-group">
                    <label for="${customerId}_name">Họ tên:</label>
                    <input type="text" id="${customerId}_name" placeholder="Họ tên khách hàng">
                </div>
                
                <div class="form-group">
                    <label for="${customerId}_year">Năm sinh:</label>
                    <input type="text" id="${customerId}_year" placeholder="Năm sinh">
                </div>
                
                <div class="form-group">
                    <label for="${customerId}_id">CMND/CCCD:</label>
                    <input type="text" id="${customerId}_id" placeholder="Số CMND/CCCD">
                </div>
                
                <div class="form-group">
                    <label for="${customerId}_id_date">Ngày cấp:</label>
                    <input type="text" id="${customerId}_id_date" placeholder="Ngày cấp">
                </div>
                
                <div class="form-group">
                    <label for="${customerId}_id_place">Nơi cấp:</label>
                    <input type="text" id="${customerId}_id_place" placeholder="Nơi cấp">
                </div>
                
                <div class="form-group">
                    <label for="${customerId}_address">Địa chỉ:</label>
                    <input type="text" id="${customerId}_address" placeholder="Địa chỉ">
                </div>
                
                <div class="form-group">
                    <label for="${customerId}_phone">Số điện thoại:</label>
                    <input type="text" id="${customerId}_phone" placeholder="Số điện thoại">
                </div>
                
                <div class="form-group">
                    <label for="${customerId}_total">Tổng nợ (tùy chỉnh):</label>
                    <input type="text" id="${customerId}_total" placeholder="Để trống sẽ dùng mẫu chung">
                </div>
            `;
            
            document.getElementById('customersContainer').appendChild(newCustomer);
            updateCustomerCount();
        }
        
        function removeCustomer(customerId) {
            const customerElement = document.getElementById(customerId);
            if (customerElement) {
                customerElement.remove();
                customerCount--;
                updateCustomerCount();
            }
        }
        
        function clearAllCustomers() {
            if (confirm('Bạn có chắc chắn muốn xóa tất cả khách hàng?')) {
                document.getElementById('customersContainer').innerHTML = '';
                customerCount = 0;
                updateCustomerCount();
            }
        }
        
        function updateCustomerCount() {
            document.getElementById('customerCount').textContent = `Số lượng khách hàng: ${customerCount}`;
        }
        
        function importFromExcel() {
            alert('Tính năng nhập từ Excel đang được phát triển. Vui lòng thêm khách hàng thủ công.');
            // Trong thực tế, bạn có thể triển khai tính năng đọc file Excel ở đây
        }
        
        // Tạo đơn hàng loạt
        function generateAllDocuments() {
            if (customerCount === 0) {
                alert('Vui lòng thêm ít nhất một khách hàng');
                return;
            }
            
            // Thu thập thông tin mẫu
            const template = collectTemplateData();
            customers = collectCustomersData();
            
            // Hiển thị tab kết quả
            switchTab(3);
            
            // Tạo đơn cho từng khách hàng
            generatedDocuments = [];
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '';
            
            document.getElementById('resultCount').textContent = `Đang tạo đơn cho: ${customerCount} khách hàng`;
            
            // Mô phỏng tiến trình
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 100 / customerCount;
                document.getElementById('generationProgress').style.width = `${Math.min(progress, 100)}%`;
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    showGenerationResults(template);
                }
            }, 100);
        }
        
        function collectTemplateData() {
            const template = {
                courtName: document.getElementById('courtName').value,
                currentDate: document.getElementById('currentDate').value,
                plaintiffName: document.getElementById('plaintiffName').value,
                plaintiffAddress: document.getElementById('plaintiffAddress').value,
                plaintiffContact: document.getElementById('plaintiffContact').value,
                legalRepresentative: document.getElementById('legalRepresentative').value,
                authorizedRepresentative: document.getElementById('authorizedRepresentative').value,
                authorizationDoc: document.getElementById('authorizationDoc').value,
                violationDate: document.getElementById('violationDate').value,
                violationDescription: document.getElementById('violationDescription').value,
                contracts: []
            };
            
            // Thu thập thông tin hợp đồng mẫu
            for (let i = 1; i <= contractCount; i++) {
                template.contracts.push({
                    type: document.getElementById(`contract${i}Type`).value,
                    date: document.getElementById(`contract${i}Date`).value,
                    amount: document.getElementById(`contract${i}Amount`).value,
                    purpose: document.getElementById(`contract${i}Purpose`).value,
                    term: document.getElementById(`contract${i}Term`).value,
                    interest: document.getElementById(`contract${i}Interest`).value,
                    debtDate: document.getElementById(`debtDate${i}`).value,
                    principal: document.getElementById(`principal${i}`).value,
                    interestAmount: document.getElementById(`interest${i}`).value,
                    total: document.getElementById(`total${i}`).value
                });
            }
            
            return template;
        }
        
        function collectCustomersData() {
            const customers = [];
            const customerElements = document.querySelectorAll('.customer-item');
            
            customerElements.forEach(customerElement => {
                const customerId = customerElement.id;
                
                customers.push({
                    id: customerId,
                    name: document.getElementById(`${customerId}_name`).value,
                    year: document.getElementById(`${customerId}_year`).value,
                    idNumber: document.getElementById(`${customerId}_id`).value,
                    idDate: document.getElementById(`${customerId}_id_date`).value,
                    idPlace: document.getElementById(`${customerId}_id_place`).value,
                    address: document.getElementById(`${customerId}_address`).value,
                    phone: document.getElementById(`${customerId}_phone`).value,
                    totalDebt: document.getElementById(`${customerId}_total`).value
                });
            });
            
            return customers;
        }
        
        function showGenerationResults(template) {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '<h3>DANH SÁCH ĐƠN ĐÃ TẠO</h3>';
            
            customers.forEach((customer, index) => {
                const documentContent = generateDocumentContent(template, customer);
                generatedDocuments.push({
                    customer: customer,
                    content: documentContent,
                    fileName: `Don_khoi_kien_${customer.name.replace(/\s+/g, '_')}.doc`
                });
                
                const resultItem = document.createElement('div');
                resultItem.className = 'customer-item';
                resultItem.innerHTML = `
                    <div class="customer-header">
                        <span>${customer.name}</span>
                        <button class="btn btn-success" onclick="downloadSingleDocument(${index})">Tải về</button>
                    </div>
                    <p><strong>CMND/CCCD:</strong> ${customer.idNumber}</p>
                    <p><strong>Địa chỉ:</strong> ${customer.address}</p>
                    <div style="margin-top: 10px;">
                        <button class="btn" onclick="previewDocument(${index})">Xem trước</button>
                    </div>
                    <div id="preview_${index}" class="hidden" style="margin-top: 10px; padding: 10px; background: #f9f9f9; border: 1px solid #ddd;">
                        <pre style="white-space: pre-wrap; font-size: 12px; max-height: 200px; overflow-y: auto;">${documentContent.substring(0, 500)}...</pre>
                    </div>
                `;
                
                resultsContainer.appendChild(resultItem);
            });
            
            document.getElementById('resultCount').textContent = `Đã tạo đơn cho: ${customerCount} khách hàng`;
        }
        
        function generateDocumentContent(template, customer) {
            // Tạo nội dung hợp đồng
            let contractsContent = '';
            template.contracts.forEach((contract, index) => {
                contractsContent += `
${index + 1}.  ${contract.type} ngày ${contract.date}, cụ thể:

- ${contract.amount.includes('Hạn mức') ? 'Hạn mức tín dụng:' : 'Số tiền cho vay:'} ${contract.amount}
- Mục đích vay: ${contract.purpose}
${contract.term ? `- Thời hạn vay: ${contract.term}` : ''}
- Lãi suất: ${contract.interest}

Dư nợ thực tế tạm tính đến ngày ${contract.debtDate} theo hợp đồng cho vay trên là:

+-------------------------------+--------------------------------------+
| - Nợ gốc:                     | ${contract.principal}                      |
+-------------------------------+--------------------------------------+
| - Nợ lãi:                     | ${contract.interestAmount}                      |
+-------------------------------+--------------------------------------+
| **Tổng cộng:**                | **${contract.total}**                  |
+===============================+======================================+

`;
            });
            
            // Tính tổng nợ
            const totalPrincipal = template.contracts.reduce((sum, contract) => {
                const principal = parseInt(contract.principal.replace(/\D/g, '')) || 0;
                return sum + principal;
            }, 0);
            
            const totalInterest = template.contracts.reduce((sum, contract) => {
                const interest = parseInt(contract.interestAmount.replace(/\D/g, '')) || 0;
                return sum + interest;
            }, 0);
            
            const grandTotal = totalPrincipal + totalInterest;
            
            // Format số tiền
            function formatCurrency(amount) {
                return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + ' đồng';
            }
            
            // Tạo nội dung đơn hoàn chỉnh
            const documentContent = `
${template.currentDate}

#### ĐƠN SỬA ĐỔI BỔ SUNG ĐƠN KHỞI KIỆN

*(V/v ông/bà ${customer.name} vi phạm hợp đồng tín dụng)*

**Kính gửi: ${template.courtName}**

I.  **Bên khởi kiện**: **${template.plaintiffName}**.

    - Địa chỉ trụ sở: ${template.plaintiffAddress}.
    - Địa chỉ liên lạc: ${template.plaintiffContact}.
    - Người đại diện theo pháp luật: **${template.legalRepresentative}**.
    - Người đại diện theo ủy quyền: **${template.authorizedRepresentative}**.

*(Theo ${template.authorizationDoc}).*

II. **Bên bị kiện: Ông/bà ${customer.name} Sinh năm: ${customer.year}**

    - CMND/CCCD số ${customer.idNumber} do ${customer.idPlace} cấp ngày ${customer.idDate}.
    - Địa chỉ: ${customer.address}.
    - Số điện thoại: ${customer.phone}

III. **Nội dung khởi kiện:**

${template.plaintiffName.split(' ')[0]} *(sau đây gọi tắt là "VPBank")* với ông/bà ${customer.name} đã cùng ký kết các Hợp đồng cho vay như sau:

${contractsContent}

Từ ngày ${template.violationDate} ông/bà ${customer.name} đã vi phạm nghĩa vụ thanh toán nợ vay cho VPBank.

${template.violationDescription}

**[YÊU CẦU CỦA NGƯỜI KHỞI KIỆN]**

Kính đề nghị Quý Tòa thụ lý giải quyết vụ án và xem xét phán quyết:

1.  Buộc ông/bà ${customer.name} phải thanh toán cho VPBank một lần tổng dư nợ tạm tính đến ngày ${template.contracts[0].debtDate} là:

+-------------------------------+--------------------------------------+
| - Nợ gốc:                     | ${formatCurrency(totalPrincipal)}                      |
+-------------------------------+--------------------------------------+
| - Nợ lãi:                     | ${formatCurrency(totalInterest)}                      |
+-------------------------------+--------------------------------------+
| **Tổng cộng:**                | **${formatCurrency(grandTotal)}**                  |
+===============================+======================================+

2.  Yêu cầu Tòa án tuyên trong bản án tiếp tục cho tính lãi theo đúng thỏa thuận trong các Hợp đồng cho đến khi ông/bà ${customer.name} thực tế thanh toán hết nợ cho VPBank.

3.  Ông/bà ${customer.name} phải chịu toàn bộ án phí và các chi phí liên quan (nếu có) do vi phạm nghĩa vụ thanh toán.

Những nội dung đã trình bày như trên là đúng sự thật, kính trình Quý Tòa thẩm xét./.

**NGƯỜI KHỞI KIỆN**

> **${template.plaintiffName.split('(')[0].trim()}**
>
> **NGƯỜI ĐẠI DIỆN THEO ỦY QUYỀN**
>
> **${template.authorizedRepresentative.split(':')[1].trim()}**
            `;
            
            return documentContent;
        }
        
        function previewDocument(index) {
            const previewElement = document.getElementById(`preview_${index}`);
            previewElement.classList.toggle('hidden');
        }
        
        function downloadSingleDocument(index) {
            const doc = generatedDocuments[index];
            const blob = new Blob([doc.content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = doc.fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function downloadAllDocuments() {
            if (generatedDocuments.length === 0) {
                alert('Không có đơn nào để tải về');
                return;
            }
            
            // Trong trình duyệt hiện đại, cần sử dụng thư viện JSZip để tạo file zip
            alert('Tính năng tải về tất cả dưới dạng ZIP đang được phát triển. Vui lòng tải từng đơn một.');
            
            // Tải về từng file một
            generatedDocuments.forEach((doc, index) => {
                setTimeout(() => {
                    downloadSingleDocument(index);
                }, index * 500);
            });
        }
        
        function downloadSummary() {
            let summaryContent = 'BÁO CÁO TỔNG HỢP ĐƠN KHỞI KIỆN\n';
            summaryContent += `Ngày tạo: ${new Date().toLocaleDateString('vi-VN')}\n`;
            summaryContent += `Tổng số khách hàng: ${customers.length}\n\n`;
            
            customers.forEach((customer, index) => {
                summaryContent += `--- KHÁCH HÀNG ${index + 1} ---\n`;
                summaryContent += `Họ tên: ${customer.name}\n`;
                summaryContent += `CMND/CCCD: ${customer.idNumber}\n`;
                summaryContent += `Địa chỉ: ${customer.address}\n`;
                summaryContent += `Số điện thoại: ${customer.phone}\n`;
                summaryContent += `File: Don_khoi_kien_${customer.name.replace(/\s+/g, '_')}.doc\n\n`;
            });
            
            const blob = new Blob([summaryContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Bao_cao_tong_hop_don_khoi_kien.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Thêm một khách hàng mẫu khi trang được tải
        window.onload = function() {
            addCustomer();
            // Điền thông tin mẫu cho khách hàng đầu tiên
            setTimeout(() => {
                const firstCustomer = document.querySelector('.customer-item');
                if (firstCustomer) {
                    const customerId = firstCustomer.id;
                    document.getElementById(`${customerId}_name`).value = 'Phan Nhật Linh';
                    document.getElementById(`${customerId}_year`).value = '1996';
                    document.getElementById(`${customerId}_id`).value = '079096006806';
                    document.getElementById(`${customerId}_id_date`).value = '22/11/2021';
                    document.getElementById(`${customerId}_id_place`).value = 'Cục Cảnh sát về QLHC và TTXH';
                    document.getElementById(`${customerId}_address`).value = '158/5A ấp Thới Tây 2, Xã Hóc Môn (Xã Tân Hiệp, Huyện Hóc Môn cũ), Thành phố Hồ Chí Minh';
                    document.getElementById(`${customerId}_phone`).value = '0901350113';
                }
            }, 100);
        }
    </script>
</body>
</html>
